# ç”¨æˆ·åé¦ˆæµç¨‹è¯´æ˜

## ğŸ“Š å®Œæ•´æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é’‰é’‰ç”¨æˆ·    â”‚  @æœºå™¨äºº åˆ›å»ºå‘¨æŠ¥ä»»åŠ¡
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åå° MessageHandler.forwardToDify       â”‚
â”‚  - æ³¨å†Œä¼šè¯ (conversation_id â†’ user_id)  â”‚
â”‚  - è½¬å‘æ¶ˆæ¯ç»™ Dify                       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Dify Workflow                           â”‚
â”‚  1. LLM åˆ†ææ„å›¾                         â”‚
â”‚  2. è°ƒç”¨å·¥å…· execute_bot_action          â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åå° DifyHandler.Execute                â”‚
â”‚  1. æŸ¥æ‰¾ä¼šè¯è·å– user_id                 â”‚
â”‚  2. æ£€æŸ¥æƒé™                             â”‚
â”‚  3. æ‰§è¡Œæ“ä½œ                             â”‚
â”‚  4. è¿”å› JSON ç»™ Dify                    â”‚
â”‚     {                                    â”‚
â”‚       "success": true,                   â”‚
â”‚       "message": "âœ… ä»»åŠ¡åˆ›å»ºæˆåŠŸï¼...",  â”‚
â”‚       "data": { task details }           â”‚
â”‚     }                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Dify Workflow (ç»§ç»­)                    â”‚
â”‚  3. æ ¹æ®å·¥å…·è¿”å›ç»“æœç”Ÿæˆ answer          â”‚
â”‚     - æ–¹æ¡ˆ1: LLM ç”Ÿæˆå‹å¥½æ–‡æœ¬            â”‚
â”‚     - æ–¹æ¡ˆ2: æ¨¡æ¿èŠ‚ç‚¹æ ¼å¼åŒ–              â”‚
â”‚     - æ–¹æ¡ˆ3: Code èŠ‚ç‚¹å¤„ç†               â”‚
â”‚  4. è¿”å› response ç»™åå°                 â”‚
â”‚     {                                    â”‚
â”‚       "answer": "âœ… ä»»åŠ¡åˆ›å»ºæˆåŠŸï¼..."   â”‚
â”‚     }                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åå° MessageHandler.forwardToDify       â”‚
â”‚  - æ¥æ”¶ Dify response                    â”‚
â”‚  - æå– answer å­—æ®µ                      â”‚
â”‚  - è°ƒç”¨ sendReply å‘é€åˆ°é’‰é’‰            â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é’‰é’‰ç”¨æˆ·    â”‚  æ”¶åˆ°åé¦ˆæ¶ˆæ¯
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”‘ å…³é”®ä»£ç ä½ç½®

### 1. ä¼šè¯æ³¨å†Œ
**æ–‡ä»¶**: `internal/handlers/message_handler.go:56-64`
```go
// æ³¨å†Œä¼šè¯ä¿¡æ¯ï¼ˆä¾› Dify åç»­è°ƒç”¨æ—¶ä½¿ç”¨ï¼‰
if h.difyHandler != nil {
    h.difyHandler.RegisterSession(
        msg.ConversationID,
        msg.SenderStaffID,
        msg.SenderNick,
        msg.ConversationID,
    )
}
```

### 2. è½¬å‘ç»™ Dify
**æ–‡ä»¶**: `internal/handlers/message_handler.go:82-153`
```go
func (h *MessageHandler) forwardToDify(ctx context.Context, msg *dingtalk.IncomingMessage, content string) error {
    // æ„é€ è¯·æ±‚
    payload := map[string]interface{}{
        "query":           content,
        "user":            msg.SenderStaffID,
        "conversation_id": msg.ConversationID,
        "response_mode":   "blocking",
    }

    // è°ƒç”¨ Dify API
    // ...

    // âœ… å…³é”®ï¼šè½¬å‘ answer åˆ°é’‰é’‰
    if difyResp.Answer != "" {
        return h.sendReply(msg, difyResp.Answer)
    }

    // âš ï¸ å¦‚æœæ²¡æœ‰ answerï¼Œç”¨æˆ·æ”¶ä¸åˆ°åé¦ˆ
    log.Printf("Dify å¤„ç†å®Œæˆï¼Œæ— ç›´æ¥å›å¤")
    return nil
}
```

### 3. Execute API
**æ–‡ä»¶**: `internal/handlers/dify_handler.go:128-208`
```go
func (h *DifyHandler) Execute(c *gin.Context) {
    // 1. è·å–ä¼šè¯ä¿¡æ¯
    session, ok := h.sessionStore.GetSession(req.ConversationID)

    // 2. éªŒè¯æƒé™
    allowed, _, reason, err := h.permService.CanExecuteCommand(...)

    // 3. æ‰§è¡Œæ“ä½œ
    // è¿”å› JSON ç»™ Dify
    c.JSON(http.StatusOK, DifyExecuteResponse{
        Success: true,
        Message: "âœ… æ“ä½œæˆåŠŸï¼",
        Data:    result,
    })
}
```

## âš ï¸ å¸¸è§é—®é¢˜

### Q1: ç”¨æˆ·æ”¶ä¸åˆ°åé¦ˆæ€ä¹ˆåŠï¼Ÿ

**åŸå› **: Dify è°ƒç”¨å·¥å…·åæ²¡æœ‰è¿”å› `answer` å­—æ®µ

**è§£å†³æ–¹æ¡ˆ**: åœ¨ Dify workflow ä¸­æ·»åŠ ç”Ÿæˆå›å¤çš„èŠ‚ç‚¹ï¼ˆè§ä¸‹æ–¹é…ç½®ç¤ºä¾‹ï¼‰

### Q2: å¦‚ä½•ç¡®ä¿ Dify è¿”å› answerï¼Ÿ

åœ¨ Dify workflow æœ€åæ·»åŠ ä¸€ä¸ªèŠ‚ç‚¹ï¼Œæ ¹æ®å·¥å…·è¿”å›ç»“æœç”Ÿæˆæ–‡æœ¬ï¼š

**æ–¹æ¡ˆ A: LLM èŠ‚ç‚¹**
```
æç¤ºè¯ï¼š
æ ¹æ®å·¥å…·æ‰§è¡Œç»“æœç”Ÿæˆå‹å¥½çš„å›å¤æ¶ˆæ¯ï¼š

å·¥å…·è¿”å›ï¼š
{{execute_bot_action.output}}

è¦æ±‚ï¼š
- å¦‚æœæˆåŠŸï¼Œç¥è´ºç”¨æˆ·å¹¶è¯´æ˜å…·ä½“ç»“æœ
- å¦‚æœå¤±è´¥ï¼Œè§£é‡ŠåŸå› å¹¶æä¾›å»ºè®®
- ä½¿ç”¨ emoji è®©æ¶ˆæ¯æ›´å‹å¥½
```

**æ–¹æ¡ˆ B: æ¨¡æ¿èŠ‚ç‚¹**
```jinja2
{% if execute_bot_action.output.success %}
{{ execute_bot_action.output.message }}
{% else %}
âŒ æ“ä½œå¤±è´¥

{{ execute_bot_action.output.message }}

{% if execute_bot_action.output.reason %}
åŸå› ï¼š{{ execute_bot_action.output.reason }}
{% endif %}
{% endif %}
```

**æ–¹æ¡ˆ C: Code èŠ‚ç‚¹**
```python
def main(tool_output):
    """
    å¤„ç†å·¥å…·è¿”å›ç»“æœï¼Œç”Ÿæˆ answer
    """
    if not tool_output:
        return {"answer": "âŒ æ“ä½œå¤±è´¥ï¼šæœªæ”¶åˆ°å·¥å…·è¿”å›ç»“æœ"}

    success = tool_output.get('success', False)
    message = tool_output.get('message', 'æ“ä½œå®Œæˆ')

    if success:
        return {"answer": message}
    else:
        reason = tool_output.get('reason', 'æœªçŸ¥åŸå› ')
        return {
            "answer": f"{message}\n\nåŸå› ï¼š{reason}"
        }
```

### Q3: å¦‚ä½•è°ƒè¯•åé¦ˆæµç¨‹ï¼Ÿ

1. **æŸ¥çœ‹åå°æ—¥å¿—**
```bash
# æŸ¥çœ‹æ˜¯å¦æ”¶åˆ° Dify çš„ answer
grep "Dify å¤„ç†å®Œæˆ" logs/app.log

# å¦‚æœçœ‹åˆ° "æ— ç›´æ¥å›å¤"ï¼Œè¯´æ˜ Dify æ²¡æœ‰è¿”å› answer
```

2. **æŸ¥çœ‹ Dify æ—¥å¿—**
- æ£€æŸ¥ workflow æ˜¯å¦æ­£ç¡®æ‰§è¡Œ
- ç¡®è®¤æœ€åä¸€ä¸ªèŠ‚ç‚¹æ˜¯å¦è¾“å‡ºäº†æ–‡æœ¬

3. **æµ‹è¯•æµç¨‹**
```bash
# 1. ç”¨æˆ·å‘é€æ¶ˆæ¯
@æœºå™¨äºº åˆ›å»ºä»»åŠ¡æµ‹è¯•

# 2. æŸ¥çœ‹åå°æ—¥å¿—
tail -f logs/app.log

# åº”è¯¥çœ‹åˆ°ï¼š
# - "è½¬å‘æ¶ˆæ¯åˆ° Dify"
# - "Dify è¯·æ±‚: conversation=xxx, user=xxx, action=create_task"
# - "å‘é€å›å¤ç»™ç”¨æˆ·: âœ… ä»»åŠ¡åˆ›å»ºæˆåŠŸï¼..."
```

## ğŸ¯ Dify é…ç½®ç¤ºä¾‹

### å®Œæ•´ Workflow ç»“æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å¼€å§‹èŠ‚ç‚¹   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   LLM èŠ‚ç‚¹ (æ„å›¾è¯†åˆ«)        â”‚
â”‚   - ç†è§£ç”¨æˆ·æ„å›¾             â”‚
â”‚   - æå–å‚æ•°                â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å·¥å…·èŠ‚ç‚¹ (execute_bot_action) â”‚
â”‚   - è°ƒç”¨åå° API             â”‚
â”‚   - æ‰§è¡Œå®é™…æ“ä½œ             â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   LLM èŠ‚ç‚¹ (ç”Ÿæˆå›å¤) â­      â”‚
â”‚   - æ ¹æ®å·¥å…·ç»“æœç”Ÿæˆæ–‡æœ¬      â”‚
â”‚   - è¾“å‡ºåˆ° answer å­—æ®µ       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç»“æŸèŠ‚ç‚¹   â”‚ â†’ è¿”å› answer
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### LLM èŠ‚ç‚¹æç¤ºè¯æ¨¡æ¿

```
ä½ æ˜¯ä¸€ä¸ªé’‰é’‰ç¾¤åŠ©æ‰‹ï¼Œåˆšåˆšæ‰§è¡Œäº†ä¸€ä¸ªæ“ä½œã€‚

## æ“ä½œç»“æœ
{{execute_bot_action.output}}

## ä»»åŠ¡
æ ¹æ®ä¸Šè¿°æ“ä½œç»“æœï¼Œç”Ÿæˆä¸€æ¡ç®€æ´ã€å‹å¥½çš„å›å¤æ¶ˆæ¯ç»™ç”¨æˆ·ã€‚

## è¦æ±‚
1. å¦‚æœ success=trueï¼š
   - ç¥è´ºç”¨æˆ·æ“ä½œæˆåŠŸ
   - è¯´æ˜å…·ä½“åšäº†ä»€ä¹ˆï¼ˆä» message å­—æ®µè·å–ï¼‰
   - å¦‚æœæœ‰é¢å¤–æ•°æ®ï¼Œç®€è¦è¯´æ˜

2. å¦‚æœ success=falseï¼š
   - æ˜ç¡®å‘ŠçŸ¥æ“ä½œå¤±è´¥
   - è§£é‡Šå¤±è´¥åŸå› ï¼ˆä» reason å­—æ®µè·å–ï¼‰
   - æä¾›è§£å†³å»ºè®®

3. ä½¿ç”¨åˆé€‚çš„ emojiï¼ˆâœ… âŒ âš ï¸ ğŸ“‹ ç­‰ï¼‰
4. ä¿æŒç®€æ´ï¼Œä¸è¶…è¿‡3è¡Œ

## ç¤ºä¾‹

æˆåŠŸç¤ºä¾‹ï¼š
```
âœ… ä»»åŠ¡åˆ›å»ºæˆåŠŸï¼

ğŸ“‹ åç§°: å®Œæˆå‘¨æŠ¥
â° Cron: 0 15 * * 5
```

å¤±è´¥ç¤ºä¾‹ï¼š
```
âŒ åˆ›å»ºä»»åŠ¡å¤±è´¥

åŸå› ï¼šç”¨æˆ·è§’è‰²ä¸º memberï¼Œæ— æƒé™æ‰§è¡Œ create_task

è¯·è”ç³»ç®¡ç†å‘˜ä¸ºæ‚¨å¼€é€šæƒé™ã€‚
```

è¯·ç›´æ¥è¾“å‡ºå›å¤å†…å®¹ï¼Œä¸è¦æœ‰ä»»ä½•å‰ç¼€æˆ–è§£é‡Šã€‚
```

## ğŸ“ æµ‹è¯•æ¸…å•

- [ ] ç”¨æˆ·å‘é€æ¶ˆæ¯åèƒ½æ”¶åˆ°åé¦ˆ
- [ ] æ“ä½œæˆåŠŸæ—¶åé¦ˆå†…å®¹æ­£ç¡®
- [ ] æ“ä½œå¤±è´¥æ—¶æ˜¾ç¤ºå¤±è´¥åŸå› 
- [ ] æƒé™ä¸è¶³æ—¶æç¤ºæ¸…æ™°
- [ ] ä¼šè¯è¿‡æœŸæ—¶æç¤ºé‡æ–°å‘é€
- [ ] æ‰€æœ‰æ“ä½œç±»å‹éƒ½æœ‰åé¦ˆ
  - [ ] create_task
  - [ ] delete_task
  - [ ] list_tasks
  - [ ] complete_task
  - [ ] view_stats
  - [ ] add_admin
  - [ ] remove_admin

## ğŸ” æ’æŸ¥æ­¥éª¤

å¦‚æœç”¨æˆ·æ”¶ä¸åˆ°åé¦ˆï¼š

1. **æ£€æŸ¥åå°æ—¥å¿—**
```bash
# æŸ¥çœ‹æ˜¯å¦æœ‰ "æ— ç›´æ¥å›å¤"
grep "æ— ç›´æ¥å›å¤" logs/app.log
```

2. **æ£€æŸ¥ Dify workflow**
- ç¡®è®¤å·¥å…·è°ƒç”¨åæœ‰ç”Ÿæˆå›å¤çš„èŠ‚ç‚¹
- ç¡®è®¤è¯¥èŠ‚ç‚¹è¾“å‡ºåˆ° answer å˜é‡

3. **æ£€æŸ¥ Dify API å“åº”**
```bash
# æŸ¥çœ‹ Dify è¿”å›çš„å®Œæ•´å“åº”
grep "Dify å“åº”" logs/app.log
```

4. **æ‰‹åŠ¨æµ‹è¯• Execute API**
```bash
curl -X POST http://localhost:8080/api/v1/dify/execute \
  -H "Content-Type: application/json" \
  -d '{
    "conversation_id": "test_conv",
    "action": "list_tasks",
    "params": {}
  }'
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Dify é›†æˆæŒ‡å—](./DIFY_INTEGRATION_GUIDE.md)
- [API æ–‡æ¡£](./API_DOCUMENTATION.md)
- [ä¼šè¯ç®¡ç†è¯´æ˜](./CONVERSATION_ID_FLOW.md)
