# DingTeam Bot 架构说明

## 系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                         钉钉群聊                              │
│         (@机器人 命令交互 / 定时消息推送)                      │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        │ Stream 连接 / HTTP API
                        │
┌───────────────────────▼─────────────────────────────────────┐
│                   DingTeam Bot 服务                          │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  消息处理层 (Message Handler)                        │   │
│  │  - 解析用户命令                                      │   │
│  │  - 权限验证                                          │   │
│  │  - 调用业务服务                                      │   │
│  └──────────────────────┬──────────────────────────────┘   │
│                         │                                    │
│  ┌──────────────────────▼──────────────────────────────┐   │
│  │  业务服务层 (Services)                               │   │
│  │  - TaskService: 任务管理                            │   │
│  │  - StatsService: 统计服务                           │   │
│  │  - ReminderService: 提醒服务                        │   │
│  └──────────────────────┬──────────────────────────────┘   │
│                         │                                    │
│  ┌──────────────────────▼──────────────────────────────┐   │
│  │  调度器 (Scheduler)                                  │   │
│  │  - Cron 定时任务                                     │   │
│  │  - 任务执行                                          │   │
│  │  - 提醒发送                                          │   │
│  └──────────────────────┬──────────────────────────────┘   │
│                         │                                    │
└─────────────────────────┼────────────────────────────────────┘
                          │
┌─────────────────────────▼────────────────────────────────────┐
│                     PostgreSQL 数据库                         │
│  - tasks: 任务配置表                                          │
│  - completion_records: 完成记录表                             │
│  - reminder_logs: 提醒日志表                                  │
└───────────────────────────────────────────────────────────────┘
```

## 核心模块说明

### 1. 消息处理层 (handlers/)
**职责**: 处理来自钉钉的消息和交互

**主要组件**:
- `MessageHandler`: 解析和路由用户命令
  - 打卡命令: "已完成"、"我已提交"
  - 查询命令: "统计"、"任务列表"
  - 管理命令: "创建任务"
  - 帮助命令: "帮助"

**关键功能**:
```go
HandleMessage()      // 处理群消息
HandleCompletion()   // 处理打卡
HandleStats()        // 处理统计查询
HandleCreateTask()   // 处理创建任务
```

### 2. 业务服务层 (services/)
**职责**: 实现核心业务逻辑

**TaskService**:
- 任务的 CRUD 操作
- 任务状态管理
- 完成记录管理

**StatsService**:
- 统计数据计算
- 报告生成
- 完成率分析

**主要方法**:
```go
// TaskService
CreateTask()         // 创建任务
GetActiveTasksByGroup()  // 获取群组任务
RecordCompletion()   // 记录完成
UpdateTaskStatus()   // 更新状态

// StatsService
GetTodayStats()      // 今日统计
GetWeeklyStats()     // 周统计
FormatStatsReport()  // 格式化报告
```

### 3. 调度器 (scheduler/)
**职责**: 定时任务执行和提醒发送

**核心流程**:
1. 启动时加载所有活跃任务
2. 根据 Cron 表达式注册到调度器
3. 按时触发任务执行
4. 根据任务类型发送不同消息
5. 记录执行日志

**任务类型处理**:
- **TASK**: 检查截止时间，过期则通报
- **NOTIFICATION**: 提前 N 分钟发送提醒

```go
registerTask()       // 注册任务到 cron
executeTask()        // 执行任务
buildTaskMessage()   // 构建任务消息
buildNotificationMessage()  // 构建通知消息
```

### 4. 钉钉客户端 (dingtalk/)
**职责**: 封装钉钉 API 调用

**Client**: HTTP API 客户端
- `GetAccessToken()`: 获取访问令牌
- `SendGroupMessage()`: 发送群消息
- `SendActionCard()`: 发送交互卡片
- `SendMarkdown()`: 发送 Markdown

**StreamClient**: Stream 事件订阅
- 订阅群消息事件
- 实时接收用户消息
- 处理回调

### 5. 数据模型 (models/)
**核心实体**:

```go
type Task struct {
    ID             int
    Name           string
    Type           TaskType      // TASK / NOTIFICATION
    CronExpr       string        // Cron 表达式
    DeadlineTime   time.Time     // 截止时间（TASK）
    AdvanceMinutes int           // 提前分钟（NOTIFICATION）
    Status         TaskStatus    // ACTIVE / PAUSED / DELETED
}

type CompletionRecord struct {
    TaskID      int
    UserID      string
    TaskDate    time.Time
    IsOnTime    bool
}
```

## 数据流

### 用户打卡流程
```
1. 用户在群里: @机器人 已完成
2. Stream 接收消息 → MessageHandler
3. 解析命令 → HandleCompletion()
4. TaskService.RecordCompletion() → 写入数据库
5. 返回成功消息给用户
```

### 定时提醒流程
```
1. Scheduler 根据 Cron 触发任务
2. executeTask() 执行任务逻辑
3. 根据任务类型构建消息
4. DingTalkClient 发送群消息
5. 记录提醒日志
6. 更新任务运行时间
```

### 统计查询流程
```
1. 用户: @机器人 统计
2. MessageHandler.HandleStats()
3. StatsService.GetTodayStats()
   - 查询完成记录
   - 计算完成率
   - 生成用户列表
4. FormatStatsReport() 格式化输出
5. 发送 Markdown 消息
```

## 任务类型对比

| 特性 | TASK（任务型） | NOTIFICATION（通知型） |
|------|----------------|----------------------|
| 目的 | 督促完成任务 | 提前提醒事项 |
| 截止时间 | 必须设置 | 不需要 |
| 提前提醒 | 可选 | 必须设置提前时间 |
| 过期处理 | 通报未完成名单 | 无过期概念 |
| 打卡 | 支持 | 可选支持 |
| 使用场景 | 周报、日报、作业 | 会议提醒、活动通知 |

## 关键设计点

### 1. 任务与通知的区分
- **任务型** 关注"完成与否"，有明确的截止时间
- **通知型** 关注"提前告知"，无完成状态

### 2. 时区处理
- 所有时间使用配置的时区（默认 Asia/Shanghai）
- Cron 调度器使用相同时区
- 数据库存储使用 UTC，展示时转换

### 3. 幂等性保证
- 打卡使用 UNIQUE 约束（task_id, user_id, task_date）
- 避免重复打卡

### 4. 扩展性设计
- 服务层解耦，便于添加新功能
- 消息处理采用命令模式
- 数据库使用枚举类型，便于扩展

## 部署架构

### Kubernetes 部署
```
┌──────────────────────────────────────────┐
│  Kubernetes Cluster                       │
│  ┌────────────────────────────────────┐  │
│  │  ConfigMap (配置)                  │  │
│  │  Secret (敏感信息)                 │  │
│  └────────────────────────────────────┘  │
│  ┌────────────────────────────────────┐  │
│  │  Deployment (dingteam-bot)         │  │
│  │  - replicas: 1                     │  │
│  │  - resources: 128Mi-512Mi          │  │
│  │  - health check                    │  │
│  └────────────────────────────────────┘  │
│  ┌────────────────────────────────────┐  │
│  │  Service (ClusterIP)               │  │
│  │  - port: 8080                      │  │
│  └────────────────────────────────────┘  │
│  ┌────────────────────────────────────┐  │
│  │  PostgreSQL (StatefulSet)          │  │
│  │  - PVC: 5Gi                        │  │
│  └────────────────────────────────────┘  │
└──────────────────────────────────────────┘
```

## 监控指标

### 建议监控的指标
1. **健康状态**: /health 端点响应时间
2. **数据库连接**: 活跃连接数
3. **任务执行**: 成功/失败次数
4. **消息发送**: 成功率、延迟
5. **用户活跃**: 打卡人数、完成率

## 安全考虑

1. **敏感信息**: 使用 K8s Secret 管理
2. **权限控制**: 管理员白名单机制
3. **输入验证**: 防止 SQL 注入、命令注入
4. **访问令牌**: 自动刷新，避免过期
5. **数据库**: 使用参数化查询

## 性能优化

1. **数据库索引**: 关键查询字段建立索引
2. **连接池**: 复用数据库连接
3. **缓存**: Access Token 缓存
4. **批量操作**: 统计查询合并
5. **异步处理**: 消息发送异步化

## 未来扩展

### Phase 2
- [ ] ActionCard 交互卡片
- [ ] 群成员自动同步
- [ ] 个人打卡历史
- [ ] 任务模板

### Phase 3
- [ ] Web 管理后台
- [ ] 数据可视化图表
- [ ] 导出报表
- [ ] 多群管理

### Phase 4
- [ ] AI 智能提醒
- [ ] 自定义工作流
- [ ] 积分激励系统
- [ ] 移动端 App
