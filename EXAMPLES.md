# 使用示例与最佳实践

## 典型使用场景

### 场景 1: 每周周报提醒

#### 需求
- 每周五下午 5 点提醒写周报
- 截止时间：下午 3 点
- 未完成的人员会被通报

#### 创建任务
```
@机器人 创建任务 写周报 "0 17 * * 5" 15:00 TASK
```

#### Cron 解释
- `0` - 秒（第 0 秒）
- `17` - 小时（17 点，即下午 5 点）
- `*` - 日（每天）
- `*` - 月（每月）
- `5` - 星期（星期五，0=周日，1=周一...6=周六）

#### 执行效果
- **周五 15:00**: 提醒写周报，可以开始打卡
- **周五 17:00**: 检查完成情况
  - 已完成：无提示
  - 未完成：群里通报未完成名单

#### 用户操作
```
# 完成后打卡
@机器人 已完成

# 查看统计
@机器人 统计
```

---

### 场景 2: 每日站会提醒

#### 需求
- 工作日上午 9:20 提醒 9:30 开站会
- 提前 10 分钟通知即可

#### 创建任务
```
@机器人 创建任务 每日站会 "0 20 9 * * 1-5" "" NOTIFICATION
```

注意：使用 NOTIFICATION 类型，设置 advance_minutes = 10

#### 执行效果
- 每个工作日 9:20 发送提醒消息
- 无需打卡，纯通知功能

---

### 场景 3: 月度 OKR 回顾

#### 需求
- 每月最后一天提醒填写 OKR
- 截止时间：当天下午 6 点

#### 创建任务
```
@机器人 创建任务 OKR回顾 "0 10 28-31 * *" 18:00 TASK
```

#### 说明
- `28-31`: 覆盖每月最后几天
- 需要结合业务逻辑判断是否为月末

---

### 场景 4: 每天下班打卡

#### 需求
- 下午 6 点提醒打卡下班
- 记录打卡时间

#### 创建任务
```
@机器人 创建任务 下班打卡 "0 18 * * 1-5" "" TASK
```

#### 用户操作
```
# 下班时打卡
@机器人 已完成

# 查看本周打卡情况
@机器人 本周统计
```

---

## Cron 表达式实用示例

### 基础示例
```bash
# 每分钟
* * * * *

# 每小时
0 * * * *

# 每天午夜
0 0 * * *

# 每周一早上 9 点
0 9 * * 1

# 每月 1 号上午 10 点
0 10 1 * *

# 每年 1 月 1 日
0 0 1 1 *
```

### 工作日/周末
```bash
# 工作日上午 9 点
0 9 * * 1-5

# 周末上午 10 点
0 10 * * 0,6

# 周五下午 5 点
0 17 * * 5
```

### 每隔 N 时间
```bash
# 每 5 分钟
*/5 * * * *

# 每 15 分钟
*/15 * * * *

# 每 2 小时
0 */2 * * *

# 每 6 小时
0 */6 * * *
```

### 特定时间段
```bash
# 工作时间（9-18 点），每小时
0 9-18 * * 1-5

# 上午（9-12 点），每 30 分钟
*/30 9-12 * * *

# 下午（14-17 点），每小时整点
0 14-17 * * *
```

### 复杂示例
```bash
# 工作日上午 9 点和下午 2 点
0 9,14 * * 1-5

# 每月 1 号和 15 号上午 10 点
0 10 1,15 * *

# 每季度第一天（1/4/7/10 月的 1 号）
0 0 1 1,4,7,10 *
```

---

## 命令参考

### 基础命令

#### 打卡
```
@机器人 已完成
@机器人 我已提交
@机器人 完成
```

#### 查询统计
```
@机器人 统计
@机器人 今日统计
@机器人 本周统计
@机器人 报告
```

#### 任务管理
```
@机器人 任务列表
@机器人 查看任务
@机器人 所有任务
```

#### 帮助
```
@机器人 帮助
@机器人 ?
@机器人 使用说明
```

### 管理员命令

#### 创建任务（完整格式）
```
@机器人 创建任务 <任务名称> <Cron表达式> [截止时间] [任务类型]

参数说明：
- 任务名称：必填，任务的显示名称
- Cron表达式：必填，定时规则
- 截止时间：可选，格式 HH:MM（如 15:00）
- 任务类型：可选，TASK 或 NOTIFICATION（默认 NOTIFICATION）
```

#### 示例
```
# 最简单：只有名称和 Cron
@机器人 创建任务 测试 "0 9 * * *"

# 带截止时间（自动为 TASK 类型）
@机器人 创建任务 写日报 "0 18 * * *" 17:00

# 完整参数（通知类型）
@机器人 创建任务 会议提醒 "0 14 * * 3" "" NOTIFICATION
```

---

## 最佳实践

### 1. 任务命名规范
- ✅ 好的命名：`写周报`、`每日站会`、`OKR回顾`
- ❌ 不好的命名：`任务1`、`test`、`提醒`

### 2. 时间设置建议

#### 任务型 (TASK)
- 提醒时间应在截止时间之后 1-2 小时
- 例：15:00 截止，17:00 提醒（给予 2 小时缓冲）

#### 通知型 (NOTIFICATION)
- 提前 10-30 分钟通知
- 避免提前太久（容易忘记）或太晚（来不及准备）

### 3. Cron 表达式建议

#### 避免高频任务
```bash
# ❌ 不推荐：每分钟
* * * * *

# ✅ 推荐：至少间隔 5 分钟
*/5 * * * *
```

#### 避免整点拥堵
```bash
# ❌ 不好：正好整点
0 9 * * *

# ✅ 更好：错开几分钟
5 9 * * *
```

#### 使用合理的时间
```bash
# ❌ 太早
0 6 * * *

# ❌ 太晚
0 23 * * *

# ✅ 工作时间内
0 9-18 * * 1-5
```

### 4. 群组管理

#### 一个群一个用途
- 不要在同一个群创建太多任务
- 建议：每个群 3-5 个任务为宜

#### 区分任务优先级
- 重要任务：使用 TASK 类型，有截止时间
- 一般提醒：使用 NOTIFICATION 类型

### 5. 管理员配置

#### 设置多个管理员
```env
ADMIN_USERS=user1,user2,user3
```

#### 权限分配原则
- 至少 2 个管理员（避免单点故障）
- 管理员应该是相对稳定的人员
- 定期审查管理员列表

### 6. 数据维护

#### 定期清理
```sql
-- 清理 3 个月前的完成记录
DELETE FROM completion_records 
WHERE completed_at < NOW() - INTERVAL '3 months';

-- 清理 6 个月前的提醒日志
DELETE FROM reminder_logs 
WHERE sent_at < NOW() - INTERVAL '6 months';
```

#### 备份策略
- 每天自动备份数据库
- 保留最近 7 天的备份
- 每周创建一次完整备份并归档

---

## 团队协作建议

### 新成员入职
1. 邀请加入钉钉群
2. @ 机器人发送"帮助"了解功能
3. 第一次打卡后查看统计

### 任务创建流程
1. 团队讨论确定需要提醒的事项
2. 管理员创建任务
3. 在群里通知大家新任务
4. 试运行 1-2 周后调整

### 反馈与改进
- 每月收集一次使用反馈
- 调整不合理的提醒时间
- 删除不再需要的任务

---

## 故障处理

### 用户反馈"收不到消息"

#### 排查步骤
1. 检查机器人是否在群里
2. 检查任务是否为 ACTIVE 状态
3. 查看任务的 next_run_at 时间
4. 查看最近的 reminder_logs

#### 解决方案
```sql
-- 检查任务状态
SELECT id, name, status, next_run_at 
FROM tasks 
WHERE group_chat_id = 'chatxxxx';

-- 检查最近的提醒日志
SELECT * FROM reminder_logs 
WHERE task_id = 123 
ORDER BY sent_at DESC 
LIMIT 5;
```

### 用户反馈"打卡失败"

#### 常见原因
1. 今天已经打过卡
2. 群里没有活跃任务
3. 数据库连接问题

#### 检查方法
```sql
-- 检查今天是否已打卡
SELECT * FROM completion_records 
WHERE user_id = 'userxxx' 
  AND task_date = CURRENT_DATE;
```

---

## 性能优化

### 数据库查询优化

#### 慢查询定位
```sql
-- 找出慢查询
SELECT query, mean_time, calls 
FROM pg_stat_statements 
ORDER BY mean_time DESC 
LIMIT 10;
```

#### 索引优化
```sql
-- 分析表使用情况
ANALYZE tasks;
ANALYZE completion_records;

-- 添加必要的索引（已在 init.sql 中）
CREATE INDEX IF NOT EXISTS idx_tasks_next_run 
ON tasks(next_run_at) 
WHERE status = 'ACTIVE';
```

### 消息发送优化

#### 批量发送
- 避免在循环中逐个发送消息
- 使用钉钉的批量接口（如果有）

#### 异步处理
```go
// 异步发送消息
go func() {
    if err := client.SendMessage(msg); err != nil {
        log.Printf("发送失败: %v", err)
    }
}()
```

---

## 安全建议

### 1. 敏感信息保护
- 不要在代码中硬编码凭证
- 使用环境变量或 K8s Secret
- 定期轮换密码和密钥

### 2. 输入验证
```go
// 验证 Cron 表达式
func validateCron(expr string) error {
    _, err := cron.ParseStandard(expr)
    return err
}

// 限制任务名称长度
if len(taskName) > 100 {
    return errors.New("任务名称过长")
}
```

### 3. 权限控制
- 严格控制管理员权限
- 记录所有管理操作
- 定期审计权限配置

### 4. 防止滥用
```go
// 限制创建任务频率
const maxTasksPerGroup = 10

func (s *TaskService) CanCreateTask(groupID string) (bool, error) {
    count, err := s.countTasksByGroup(groupID)
    if err != nil {
        return false, err
    }
    return count < maxTasksPerGroup, nil
}
```

---

## FAQ

### Q: 可以创建多少个任务？
A: 建议每个群不超过 10 个任务。太多任务会让群消息过于频繁。

### Q: 任务可以暂停吗？
A: 可以，管理员可以将任务状态改为 PAUSED（需要开发暂停功能）。

### Q: 如何修改已有任务？
A: 目前需要删除后重新创建。后续版本会支持任务编辑。

### Q: 打卡记录可以撤销吗？
A: 当前版本不支持撤销。后续可以添加此功能。

### Q: 支持私聊机器人吗？
A: 当前仅支持群聊。私聊功能可以在后续版本添加。

### Q: 时区如何设置？
A: 在环境变量中设置 `TIMEZONE=Asia/Shanghai`。

---

## 进阶功能（待开发）

### 1. ActionCard 交互卡片
- 一键打卡按钮
- 任务详情展示
- 快捷操作菜单

### 2. 个性化配置
- 用户自定义提醒时间
- 免打扰时段设置
- 通知方式选择

### 3. 数据分析
- 个人完成率趋势
- 团队活跃度分析
- 任务完成耗时统计

### 4. 集成扩展
- 对接项目管理系统
- 关联文档协作平台
- 同步日历事件

---

## 贡献指南

欢迎贡献代码、文档或建议！

### 提交 Issue
- 描述问题或需求
- 提供复现步骤
- 附上相关日志

### 提交 PR
- Fork 项目
- 创建功能分支
- 编写测试
- 提交 PR

---

**Happy Coding! 🚀**
