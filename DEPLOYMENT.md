# éƒ¨ç½²æ£€æŸ¥æ¸…å•

## éƒ¨ç½²å‰å‡†å¤‡

### 1. é’‰é’‰é…ç½® âœ“
- [ ] å·²åˆ›å»ºä¼ä¸šå†…éƒ¨åº”ç”¨
- [ ] å·²å¼€å¯æœºå™¨äººèƒ½åŠ›
- [ ] å·²è®¢é˜…ç¾¤æ¶ˆæ¯äº‹ä»¶ï¼ˆ`chat_update_title`ã€`chat_add_member` ç­‰ï¼‰
- [ ] å·²è·å–ä»¥ä¸‹å‡­è¯ï¼š
  - [ ] AppKey
  - [ ] AppSecret
  - [ ] AgentID
  - [ ] RobotCode
- [ ] æœºå™¨äººå·²åŠ å…¥æµ‹è¯•ç¾¤
- [ ] å·²é…ç½®æœåŠ¡å™¨å‡ºå£ IPï¼ˆé’‰é’‰å¼€æ”¾å¹³å°ï¼‰

### 2. æ•°æ®åº“å‡†å¤‡ âœ“
- [ ] PostgreSQL 15+ å·²å®‰è£…
- [ ] å·²åˆ›å»ºæ•°æ®åº“ `dingteam_bot`
- [ ] å·²åˆ›å»ºæ•°æ®åº“ç”¨æˆ·å¹¶æˆæƒ
- [ ] å·²æ‰§è¡Œåˆå§‹åŒ–è„šæœ¬ `scripts/init.sql`
- [ ] æ•°æ®åº“å¯ä»åº”ç”¨æœåŠ¡å™¨è®¿é—®
- [ ] å·²é…ç½®æ•°æ®åº“å¤‡ä»½ç­–ç•¥

### 3. ç¯å¢ƒé…ç½® âœ“
- [ ] å·²å‡†å¤‡ `.env` æ–‡ä»¶æˆ– K8s Secret
- [ ] å·²é…ç½®ç®¡ç†å‘˜ç™½åå•
- [ ] å·²è®¾ç½®æ­£ç¡®çš„æ—¶åŒº
- [ ] æ‰€æœ‰å¿…éœ€ç¯å¢ƒå˜é‡å·²å¡«å†™

### 4. åŸºç¡€è®¾æ–½ âœ“
- [ ] Kubernetes é›†ç¾¤å¯ç”¨ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
- [ ] Docker ç¯å¢ƒå¯ç”¨ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
- [ ] kubectl å·²é…ç½®å¹¶å¯è¿æ¥é›†ç¾¤
- [ ] æœ‰è¶³å¤Ÿçš„èµ„æºé…é¢ï¼ˆCPU/å†…å­˜ï¼‰

---

## Kubernetes éƒ¨ç½²æ£€æŸ¥

### Step 1: å‡†å¤‡é…ç½®æ–‡ä»¶
```bash
# æ£€æŸ¥æ‰€æœ‰é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
ls -l deployments/k8s/
# åº”è¯¥çœ‹åˆ°ï¼š
# - configmap.yaml
# - secret.yaml
# - deployment.yaml
# - service.yaml
# - postgres.yaml
```

### Step 2: æ›´æ–° Secret
```bash
# ç¼–è¾‘ Secret æ–‡ä»¶
vim deployments/k8s/secret.yaml

# å¿…é¡»æ›´æ–°çš„å­—æ®µï¼š
# - DINGTALK_APP_KEY
# - DINGTALK_APP_SECRET
# - DINGTALK_AGENT_ID
# - DINGTALK_ROBOT_CODE
# - DB_PASSWORD
# - ADMIN_USERS
```

- [ ] å·²æ›´æ–°æ‰€æœ‰ Secret å­—æ®µä¸ºå®é™…å€¼
- [ ] Secret å€¼å·² Base64 ç¼–ç ï¼ˆå¦‚æœä½¿ç”¨ `data` å­—æ®µï¼‰
- [ ] å·²éªŒè¯ Secret æ ¼å¼æ­£ç¡®

### Step 3: éƒ¨ç½²æ•°æ®åº“ï¼ˆå¯é€‰ï¼‰
```bash
# å¦‚æœä½¿ç”¨å†…ç½® PostgreSQL
kubectl apply -f deployments/k8s/postgres.yaml

# ç­‰å¾… Pod å°±ç»ª
kubectl wait --for=condition=ready pod -l app=postgres --timeout=60s
```

- [ ] PostgreSQL Pod è¿è¡Œæ­£å¸¸
- [ ] PVC å·²åˆ›å»ºå¹¶ç»‘å®š
- [ ] æ•°æ®åº“å¯è¿æ¥

### Step 4: éƒ¨ç½²åº”ç”¨
```bash
# åº”ç”¨æ‰€æœ‰é…ç½®
kubectl apply -f deployments/k8s/configmap.yaml
kubectl apply -f deployments/k8s/secret.yaml
kubectl apply -f deployments/k8s/deployment.yaml
kubectl apply -f deployments/k8s/service.yaml
```

- [ ] ConfigMap å·²åˆ›å»º
- [ ] Secret å·²åˆ›å»º
- [ ] Deployment å·²åˆ›å»º
- [ ] Service å·²åˆ›å»º

### Step 5: éªŒè¯éƒ¨ç½²
```bash
# æ£€æŸ¥ Pod çŠ¶æ€
kubectl get pods -l app=dingteam-bot

# åº”è¯¥çœ‹åˆ°ï¼š
# NAME                            READY   STATUS    RESTARTS   AGE
# dingteam-bot-xxxxxxxxxx-xxxxx   1/1     Running   0          30s
```

- [ ] Pod çŠ¶æ€ä¸º Running
- [ ] Ready ä¸º 1/1
- [ ] æ²¡æœ‰é¢‘ç¹é‡å¯ï¼ˆRESTARTS < 3ï¼‰

### Step 6: æ£€æŸ¥æ—¥å¿—
```bash
# æŸ¥çœ‹å¯åŠ¨æ—¥å¿—
kubectl logs -f deployment/dingteam-bot --tail=50
```

æœŸæœ›çœ‹åˆ°çš„æ—¥å¿—ï¼š
- [ ] `âœ“ é…ç½®åŠ è½½å®Œæˆ`
- [ ] `âœ“ æ•°æ®åº“è¿æ¥æˆåŠŸ`
- [ ] `âœ“ æ•°æ®åº“è¿ç§»å®Œæˆ`
- [ ] `âœ“ é’‰é’‰è¿æ¥æˆåŠŸ`
- [ ] `âœ“ è°ƒåº¦å™¨å·²å¯åŠ¨`
- [ ] `âœ“ é’‰é’‰ Stream å®¢æˆ·ç«¯å·²å¯åŠ¨`
- [ ] `âœ“ HTTP æœåŠ¡å™¨å¯åŠ¨åœ¨ :8080`
- [ ] `âœ… DingTeam Bot è¿è¡Œä¸­...`
- [ ] æ²¡æœ‰ ERROR çº§åˆ«æ—¥å¿—

### Step 7: å¥åº·æ£€æŸ¥
```bash
# ç«¯å£è½¬å‘
kubectl port-forward svc/dingteam-bot-service 8080:8080

# å¦ä¸€ä¸ªç»ˆç«¯æµ‹è¯•
curl http://localhost:8080/health
```

æœŸæœ›è¿”å›ï¼š
```json
{
  "status": "ok",
  "service": "dingteam-bot"
}
```

- [ ] å¥åº·æ£€æŸ¥è¿”å› 200
- [ ] å“åº”å†…å®¹æ­£ç¡®

---

## åŠŸèƒ½éªŒè¯

### 1. é’‰é’‰è¿æ¥æµ‹è¯•
åœ¨é’‰é’‰ç¾¤é‡Œå‘é€ï¼š
```
@æœºå™¨äºº å¸®åŠ©
```

æœŸæœ›ç»“æœï¼š
- [ ] æœºå™¨äººæœ‰å“åº”
- [ ] è¿”å›å¸®åŠ©ä¿¡æ¯
- [ ] å“åº”æ—¶é—´ < 3 ç§’

### 2. åˆ›å»ºä»»åŠ¡æµ‹è¯•
ç®¡ç†å‘˜åœ¨ç¾¤é‡Œå‘é€ï¼š
```
@æœºå™¨äºº åˆ›å»ºä»»åŠ¡ æµ‹è¯•ä»»åŠ¡ "*/5 * * * *" "" NOTIFICATION
```

æœŸæœ›ç»“æœï¼š
- [ ] è¿”å›åˆ›å»ºæˆåŠŸæ¶ˆæ¯
- [ ] æ•°æ®åº“ä¸­æœ‰è®°å½•
- [ ] 5åˆ†é’Ÿåæ”¶åˆ°æé†’æ¶ˆæ¯

éªŒè¯æ•°æ®åº“ï¼š
```bash
kubectl exec -it deployment/dingteam-bot -- sh
psql $DB_HOST -U $DB_USER -d $DB_NAME -c "SELECT * FROM tasks;"
```

### 3. æ‰“å¡æµ‹è¯•
åœ¨ç¾¤é‡Œå‘é€ï¼š
```
@æœºå™¨äºº å·²å®Œæˆ
```

æœŸæœ›ç»“æœï¼š
- [ ] è¿”å›æ‰“å¡æˆåŠŸæ¶ˆæ¯
- [ ] æ•°æ®åº“ä¸­æœ‰å®Œæˆè®°å½•

éªŒè¯æ•°æ®åº“ï¼š
```sql
SELECT * FROM completion_records WHERE task_date = CURRENT_DATE;
```

### 4. ç»Ÿè®¡æµ‹è¯•
åœ¨ç¾¤é‡Œå‘é€ï¼š
```
@æœºå™¨äºº ç»Ÿè®¡
```

æœŸæœ›ç»“æœï¼š
- [ ] è¿”å›ç»Ÿè®¡æŠ¥å‘Š
- [ ] æ•°æ®å‡†ç¡®ï¼ˆå®Œæˆäººæ•°ã€å®Œæˆç‡ï¼‰
- [ ] æ ¼å¼æ¸…æ™°

### 5. ä»»åŠ¡åˆ—è¡¨æµ‹è¯•
```
@æœºå™¨äºº ä»»åŠ¡åˆ—è¡¨
```

æœŸæœ›ç»“æœï¼š
- [ ] è¿”å›æ‰€æœ‰æ´»è·ƒä»»åŠ¡
- [ ] ä¿¡æ¯å®Œæ•´ï¼ˆåç§°ã€ç±»å‹ã€Cronï¼‰

---

## ç›‘æ§é…ç½®

### 1. æ—¥å¿—ç›‘æ§
```bash
# æŒç»­ç›‘æ§æ—¥å¿—
kubectl logs -f deployment/dingteam-bot | grep -E "ERROR|WARN|FATAL"
```

å…³æ³¨çš„æ—¥å¿—ï¼š
- [ ] æ•°æ®åº“è¿æ¥é”™è¯¯
- [ ] é’‰é’‰ API é”™è¯¯
- [ ] ä»»åŠ¡æ‰§è¡Œå¤±è´¥
- [ ] Stream è¿æ¥æ–­å¼€

### 2. èµ„æºç›‘æ§
```bash
# æŸ¥çœ‹èµ„æºä½¿ç”¨
kubectl top pod -l app=dingteam-bot
```

æ­£å¸¸èŒƒå›´ï¼š
- [ ] CPU < 200m
- [ ] Memory < 300Mi

### 3. è®¾ç½®å‘Šè­¦ï¼ˆå¯é€‰ï¼‰
- [ ] CPU ä½¿ç”¨ç‡è¶…è¿‡ 80%
- [ ] å†…å­˜ä½¿ç”¨ç‡è¶…è¿‡ 80%
- [ ] Pod é‡å¯æ¬¡æ•° > 3
- [ ] å¥åº·æ£€æŸ¥å¤±è´¥

---

## å¸¸è§é—®é¢˜æ’æŸ¥

### Pod ä¸€ç›´é‡å¯
```bash
# æŸ¥çœ‹è¯¦ç»†äº‹ä»¶
kubectl describe pod -l app=dingteam-bot

# æŸ¥çœ‹ä¸Šä¸€æ¬¡å¯åŠ¨æ—¥å¿—
kubectl logs -p deployment/dingteam-bot
```

å¯èƒ½åŸå› ï¼š
- [ ] æ•°æ®åº“è¿æ¥å¤±è´¥ï¼ˆæ£€æŸ¥ DB_HOSTã€DB_PASSWORDï¼‰
- [ ] é’‰é’‰å‡­è¯é”™è¯¯ï¼ˆæ£€æŸ¥ AppKeyã€AppSecretï¼‰
- [ ] å¥åº·æ£€æŸ¥å¤±è´¥ï¼ˆæ£€æŸ¥ç«¯å£é…ç½®ï¼‰
- [ ] èµ„æºä¸è¶³ï¼ˆå¢åŠ  resources.requestsï¼‰

### é’‰é’‰æ¶ˆæ¯æ”¶ä¸åˆ°
æ£€æŸ¥ï¼š
- [ ] Stream å®¢æˆ·ç«¯æ˜¯å¦è¿æ¥æˆåŠŸï¼ˆæŸ¥çœ‹æ—¥å¿—ï¼‰
- [ ] æœºå™¨äººæ˜¯å¦åœ¨ç¾¤é‡Œ
- [ ] ç¾¤æ¶ˆæ¯äº‹ä»¶æ˜¯å¦è®¢é˜…
- [ ] AppKey/AppSecret æ˜¯å¦æ­£ç¡®
- [ ] ç½‘ç»œæ˜¯å¦å¯è¾¾é’‰é’‰æœåŠ¡å™¨

æµ‹è¯• Access Tokenï¼š
```bash
kubectl exec -it deployment/dingteam-bot -- sh
# åœ¨å®¹å™¨å†…æµ‹è¯•
curl "https://oapi.dingtalk.com/gettoken?appkey=$DINGTALK_APP_KEY&appsecret=$DINGTALK_APP_SECRET"
```

### ä»»åŠ¡æ²¡æœ‰è§¦å‘
æ£€æŸ¥ï¼š
- [ ] è°ƒåº¦å™¨æ˜¯å¦å¯åŠ¨ï¼ˆæŸ¥çœ‹æ—¥å¿—ï¼‰
- [ ] Cron è¡¨è¾¾å¼æ˜¯å¦æ­£ç¡®
- [ ] æ—¶åŒºé…ç½®æ˜¯å¦æ­£ç¡®
- [ ] ä»»åŠ¡çŠ¶æ€æ˜¯å¦ä¸º ACTIVE

éªŒè¯ Cron è¡¨è¾¾å¼ï¼š
```bash
# åœ¨çº¿å·¥å…·ï¼šhttps://crontab.guru/
# æˆ–ä½¿ç”¨ Go ä»£ç æµ‹è¯•
```

### æ•°æ®åº“å†™å…¥å¤±è´¥
æ£€æŸ¥ï¼š
- [ ] æ•°æ®åº“è¿æ¥æ˜¯å¦æ­£å¸¸
- [ ] è¡¨ç»“æ„æ˜¯å¦æ­£ç¡®ï¼ˆè¿è¡Œ init.sqlï¼‰
- [ ] å­—æ®µç±»å‹æ˜¯å¦åŒ¹é…
- [ ] UNIQUE çº¦æŸå†²çª

---

## å›æ»šè®¡åˆ’

å¦‚æœéƒ¨ç½²å‡ºç°é—®é¢˜ï¼Œæ‰§è¡Œå›æ»šï¼š

### å¿«é€Ÿå›æ»š
```bash
# åˆ é™¤åº”ç”¨
kubectl delete -f deployments/k8s/deployment.yaml

# æ¢å¤åˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬
kubectl rollout undo deployment/dingteam-bot

# æˆ–æŒ‡å®šç‰ˆæœ¬
kubectl rollout undo deployment/dingteam-bot --to-revision=2
```

### æ•°æ®åº“å›æ»š
```bash
# æ¢å¤æ•°æ®åº“å¤‡ä»½
kubectl exec -it postgres-xxx -- sh
psql -U postgres dingteam_bot < /backup/backup.sql
```

---

## ç”Ÿäº§ç¯å¢ƒå»ºè®®

### 1. èµ„æºé…ç½®
```yaml
resources:
  requests:
    memory: "256Mi"
    cpu: "200m"
  limits:
    memory: "1Gi"
    cpu: "1000m"
```

### 2. å‰¯æœ¬æ•°
- å»ºè®®å•å‰¯æœ¬è¿è¡Œï¼ˆé¿å…å®šæ—¶ä»»åŠ¡é‡å¤ï¼‰
- å¦‚éœ€é«˜å¯ç”¨ï¼Œå®ç°åˆ†å¸ƒå¼é”

### 3. æ•°æ®åº“
- ä½¿ç”¨å¤–éƒ¨æ‰˜ç®¡æ•°æ®åº“ï¼ˆAWS RDSã€é˜¿é‡Œäº‘ RDSï¼‰
- é…ç½®ä¸»ä»å¤åˆ¶
- å®šæœŸå¤‡ä»½ï¼ˆæ¯å¤©ï¼‰
- ä¿ç•™ 7 å¤©å¤‡ä»½

### 4. ç›‘æ§
- æ¥å…¥ Prometheus + Grafana
- é…ç½®å‘Šè­¦è§„åˆ™
- æ—¥å¿—èšåˆï¼ˆELKã€Lokiï¼‰

### 5. å®‰å…¨
- ä½¿ç”¨ K8s NetworkPolicy
- å¯ç”¨ RBAC
- å®šæœŸæ›´æ–°ä¾èµ–
- æ‰«æé•œåƒæ¼æ´

---

## éƒ¨ç½²å®Œæˆæ£€æŸ¥è¡¨

æœ€ç»ˆç¡®è®¤ï¼š
- [ ] æ‰€æœ‰ Pod æ­£å¸¸è¿è¡Œ
- [ ] å¥åº·æ£€æŸ¥é€šè¿‡
- [ ] é’‰é’‰è¿æ¥æ­£å¸¸
- [ ] åŠŸèƒ½æµ‹è¯•é€šè¿‡
- [ ] æ—¥å¿—æ²¡æœ‰é”™è¯¯
- [ ] ç›‘æ§å·²é…ç½®
- [ ] å¤‡ä»½ç­–ç•¥å·²å®æ–½
- [ ] æ–‡æ¡£å·²æ›´æ–°

ğŸ‰ æ­å–œï¼DingTeam Bot å·²æˆåŠŸéƒ¨ç½²ï¼
